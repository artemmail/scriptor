@using YandexSpeech.models.DTO.Telegram
@model YandexSpeech.models.DTO.Profile.ProfileIndexViewModel
@{
    ViewData["Title"] = "Профиль";
    var successMessage = TempData["ProfileSuccess"] as string;
    var infoMessage = TempData["ProfileInfo"] as string;
    var errorMessage = TempData["ProfileError"] as string;

    string FormatUtc(DateTime? value)
        => value.HasValue ? value.Value.ToUniversalTime().ToString("yyyy-MM-dd HH:mm:ss 'UTC'") : "—";

    string DescribeTelegramState(string state) => state switch
    {
        TelegramIntegrationStates.Linked => "Привязан",
        TelegramIntegrationStates.Pending => "Ожидает подтверждения",
        TelegramIntegrationStates.Revoked => "Отключён",
        TelegramIntegrationStates.Error => "Ошибка",
        _ => "Не привязан"
    };

    string? DescribeTelegramDetail(string? detail) => detail switch
    {
        TelegramIntegrationDetails.AwaitingConfirmation => "Ожидается подтверждение привязки в профиле.",
        TelegramIntegrationDetails.GoogleMissing => "Нужно подключить Google Calendar.",
        TelegramIntegrationDetails.GoogleScopeInsufficient => "Не хватает прав доступа Google Calendar.",
        TelegramIntegrationDetails.GoogleRevoked => "Доступ к Google Calendar был отозван.",
        TelegramIntegrationDetails.TokenExpired => "Требуется обновить доступ к Google Calendar.",
        TelegramIntegrationDetails.InternalError => "Произошла внутренняя ошибка интеграции.",
        TelegramIntegrationDetails.LinkMissing => "Связка с Telegram ещё не настроена.",
        _ => null
    };
}

<h1>Профиль</h1>

@if (!string.IsNullOrWhiteSpace(successMessage))
{
    <div class="alert alert-success" role="alert">@successMessage</div>
}

@if (!string.IsNullOrWhiteSpace(infoMessage))
{
    <div class="alert alert-info" role="alert">@infoMessage</div>
}

@if (!string.IsNullOrWhiteSpace(errorMessage))
{
    <div class="alert alert-danger" role="alert">@errorMessage</div>
}

<section class="profile-section">
    <h2>Основная информация</h2>
    <dl class="profile-dictionary">
        <dt>Имя</dt>
        <dd>@Model.DisplayName</dd>
        <dt>Email</dt>
        <dd>@Model.Email</dd>
    </dl>
</section>

<section class="profile-section">
    <h2>Google Calendar</h2>

    @if (Model.GoogleCalendar.IsConnected)
    {
        <p class="integration-status integration-status--connected">
            Интеграция с Google Calendar активна.
        </p>
    }
    else if (Model.GoogleCalendar.TokensRevokedAt.HasValue)
    {
        <p class="integration-status integration-status--revoked">
            Доступ к Google Calendar отключён @FormatUtc(Model.GoogleCalendar.TokensRevokedAt).
        </p>
    }
    else
    {
        <p class="integration-status integration-status--idle">
            Интеграция с Google Calendar не настроена.
        </p>
    }

    <ul class="integration-details">
        <li><strong>Согласие выдано:</strong> @FormatUtc(Model.GoogleCalendar.ConsentAt)</li>
        <li><strong>Последнее обновление токенов:</strong> @FormatUtc(Model.GoogleCalendar.AccessTokenUpdatedAt)</li>
        <li><strong>Access token действует до:</strong> @FormatUtc(Model.GoogleCalendar.AccessTokenExpiresAt)</li>
        <li><strong>Refresh token:</strong> @(Model.GoogleCalendar.HasRefreshToken ? "получен" : "нет")</li>
        <li><strong>Refresh token действует до:</strong> @FormatUtc(Model.GoogleCalendar.RefreshTokenExpiresAt)</li>
        <li><strong>Последнее отключение:</strong> @FormatUtc(Model.GoogleCalendar.TokensRevokedAt)</li>
    </ul>

    <div class="integration-actions">
        @if (Model.GoogleCalendar.IsConnected)
        {
            <form method="post" action="@Url.Action("DisconnectGoogleCalendar", "Profile")">
                @Html.AntiForgeryToken()
                <button type="submit" class="btn btn-outline-danger">Отключить интеграцию</button>
            </form>
        }
        else
        {
            <form method="post" action="@Url.Action("ConnectGoogleCalendar", "Profile")">
                @Html.AntiForgeryToken()
                <button type="submit" class="btn btn-primary">Подключить Google Calendar</button>
            </form>
        }
    </div>

    <p class="integration-hint">
        При подключении откроется окно авторизации Google. После успешного подтверждения доступ
        будет сохранён, а при отключении все токены будут удалены.
    </p>
</section>

<section class="profile-section">
    <h2>Telegram-бот</h2>

    @{
        var telegram = Model.Telegram;
        var stateDescription = DescribeTelegramState(telegram.State);
        var detailDescription = DescribeTelegramDetail(telegram.DetailCode);
    }

    @if (telegram.HasCalendarAccess)
    {
        <p class="integration-status integration-status--connected">
            Telegram-бот привязан и доступ к Google Calendar активен.
        </p>
    }
    else if (telegram.IsLinked)
    {
        <p class="integration-status integration-status--pending">
            Telegram-бот привязан, но требуется подтвердить доступ к Google Calendar.
        </p>
    }
    else
    {
        <p class="integration-status integration-status--idle">
            Telegram-бот не привязан к аккаунту.
        </p>
    }

    <ul class="integration-details">
        <li><strong>Статус:</strong> @stateDescription</li>
        <li><strong>Доступ к календарю:</strong> @(telegram.HasCalendarAccess ? "есть" : "нет")</li>
        <li><strong>Авторизация Google:</strong> @(telegram.GoogleAuthorized ? "подтверждена" : "нет")</li>
        <li><strong>Необходимые права:</strong> @(telegram.HasRequiredScope ? "выданы" : "не выданы")</li>
        @if (telegram.AccessTokenExpired)
        {
            <li><strong>Токен доступа:</strong> истёк</li>
        }
        @if (!string.IsNullOrEmpty(detailDescription))
        {
            <li><strong>Подробности:</strong> @detailDescription</li>
        }
        else if (!string.IsNullOrEmpty(telegram.DetailCode))
        {
            <li><strong>Код детали:</strong> @telegram.DetailCode</li>
        }
        <li><strong>Привязан:</strong> @FormatUtc(telegram.LinkedAt)</li>
        <li><strong>Активность:</strong> @FormatUtc(telegram.LastActivityAt)</li>
        <li><strong>Проверка статуса:</strong> @FormatUtc(telegram.LastStatusCheckAt)</li>
        @if (!string.IsNullOrWhiteSpace(telegram.PermissionScope))
        {
            <li><strong>Права Google:</strong> @telegram.PermissionScope</li>
        }
    </ul>

    <div class="integration-actions">
        <a class="btn btn-primary" href="@Url.Action("TelegramLink", "Profile")">Открыть страницу привязки</a>
    </div>

    <p class="integration-hint">
        Выполните команду <code>/link</code> в Telegram-боте YouScriptor, чтобы получить одноразовую ссылку на страницу привязки.
        После подтверждения проверьте, что интеграция с Google Calendar остаётся активной.
    </p>
</section>

<style>
    .profile-section {
        margin-bottom: 2rem;
        padding: 1.5rem;
        border: 1px solid #e5e5e5;
        border-radius: 8px;
        background-color: #fafafa;
    }

    .profile-dictionary {
        display: grid;
        grid-template-columns: minmax(120px, 200px) 1fr;
        gap: 0.75rem 1.5rem;
        margin: 0;
    }

    .profile-dictionary dt {
        font-weight: 600;
    }

    .integration-status {
        font-size: 1rem;
        margin-bottom: 1rem;
    }

    .integration-status--connected {
        color: #0f5132;
    }

    .integration-status--revoked {
        color: #664d03;
    }

    .integration-status--idle {
        color: #333333;
    }

    .integration-status--pending {
        color: #0d6efd;
    }

    .integration-details {
        list-style: none;
        padding: 0;
        margin: 0 0 1.5rem 0;
    }

    .integration-details li {
        margin-bottom: 0.5rem;
    }

    .integration-actions form {
        display: inline-block;
        margin-right: 1rem;
    }

    .integration-actions .btn {
        margin-right: 1rem;
    }

    .integration-actions .btn:last-child {
        margin-right: 0;
    }

    .integration-hint {
        font-size: 0.9rem;
        color: #555;
        margin-top: 1rem;
    }

    .btn {
        display: inline-block;
        padding: 0.5rem 1rem;
        border-radius: 4px;
        border: 1px solid transparent;
        cursor: pointer;
        font-size: 1rem;
    }

    .btn-primary {
        background-color: #0d6efd;
        border-color: #0d6efd;
        color: #fff;
    }

    .btn-outline-danger {
        background-color: transparent;
        border-color: #dc3545;
        color: #dc3545;
    }

    .btn-outline-danger:hover,
    .btn-primary:hover {
        opacity: 0.9;
    }
</style>
