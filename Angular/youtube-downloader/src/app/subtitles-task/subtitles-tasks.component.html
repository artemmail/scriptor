<div class="subtitles-page">
  <main class="page-content">
    <section class="hero" *ngIf="!isMobile">
      <div class="hero-text">
        <h1>Scriptorium</h1>
        <p class="hero-lead">
          Scriptorium(lat) - средневековая библиотека. В нашем современном аналоге вы найдете историю уже распознанных YouTube лекций, учебных материалов, подкастов и других материалов, оставленных на конспектирование скриптором.          
        </p>
        <ul class="hero-highlights">
          <li>Тысячи учебных лекций в IT, философии, физике и проч.</li>          
          <li>Поиск по названию и каналу в очереди</li>        
          <li>Экспорт в PDF, Word, Markdown, HTML</li>          
        </ul>
      </div>
      <div class="hero-card">
        <div class="card-header">Статистика очереди</div>
        <div class="queue-metrics">
          <div class="metric">
            <span class="metric-label">Всего задач</span>
            <span class="metric-value">{{ totalItems | number:'1.0-0' }}</span>
          </div>
          <div class="metric">
            <span class="metric-label">Отображено</span>
            <span class="metric-value">{{ completedTasksCount | number:'1.0-0' }}</span>
          </div>
          <div class="metric">
            <span class="metric-label">В обработке</span>
            <span class="metric-value">{{ inProgressTasksCount | number:'1.0-0' }}</span>
          </div>
          <div class="metric">
            <span class="metric-label">Ошибки</span>
            <span class="metric-value">{{ failedTasksCount | number:'1.0-0' }}</span>
          </div>
        </div>
        <div class="card-hint">Статистика считает элементы на текущей странице выдачи.</div>
      </div>
    </section>

    <section class="tasks-section">
      <mat-card *ngIf="!isMobile" class="tasks-card">
        <mat-card-header>
          <mat-card-title>Очередь распознавания</mat-card-title>
          <mat-card-subtitle>Отсортируйте список, воспользуйтесь поиском или раскройте карточку, чтобы увидеть превью.</mat-card-subtitle>
        </mat-card-header>

        <mat-card-content>
          <div
            class="table-scroll"
            infiniteScroll
            [scrollWindow]="true"
            [infiniteScrollDistance]="1"
            [infiniteScrollThrottle]="200"
            (scrolled)="onScrollDown()"
          >
            <div class="filter-toolbar">
              <label class="filter-label" for="tasks-filter-input">Фильтр по названию или каналу</label>
              <div class="filter-field">
                <input
                  #filterInput
                  id="tasks-filter-input"
                  type="text"
                  [value]="filterValue"
                  (input)="applyFilter($event)"
                  placeholder="Начните печатать..."
                  autocomplete="off"
                />
                <button
                  *ngIf="filterValue"
                  type="button"
                  class="filter-reset-btn"
                  (click)="clearFilter(filterInput)"
                >
                  Очистить
                </button>
              </div>
            </div>

            <app-yandex-ad></app-yandex-ad>

            <table
              mat-table
              [dataSource]="dataSource"
              matSort
              (matSortChange)="onSortChange($event)"
              class="custom-table"
            >
              <ng-container matColumnDef="status">
                <th mat-header-cell *matHeaderCellDef mat-sort-header="status">Статус</th>
                <td mat-cell *matCellDef="let task">
                  <mat-icon [ngClass]="getStatusClass(task.status)">{{ getStatusIcon(task.status) }}</mat-icon>
                </td>
              </ng-container>

              <ng-container matColumnDef="createdAt">
                <th mat-header-cell *matHeaderCellDef mat-sort-header="createdAt">Создано</th>
                <td mat-cell *matCellDef="let task">
                  {{ task.createdAt | localTime:'yyyy-MM-dd HH:mm:ss' }}
                </td>
              </ng-container>

              <ng-container *ngIf="isAuthenticated" matColumnDef="youtube">
                <th mat-header-cell *matHeaderCellDef>Видео</th>
                <td mat-cell *matCellDef="let task">
                  <button class="youtube-logo-button" matRipple (click)="openVideoDialog(task)">
                    <img src="assets/yt.webp" alt="YouTube" class="youtube-logo">
                  </button>
                </td>
              </ng-container>

              <ng-container matColumnDef="title">
                <th mat-header-cell *matHeaderCellDef mat-sort-header="title">Название видео</th>
                <td mat-cell *matCellDef="let task">
                  <a [routerLink]="['/recognized', task.slug]">{{ task.title }}</a>
                </td>
              </ng-container>

              
              <ng-container matColumnDef="channelName">
                <th mat-header-cell *matHeaderCellDef mat-sort-header="channelName">Канал</th>
                <td mat-cell *matCellDef="let task">{{ task.channelName }}</td>
              </ng-container>

              <ng-container matColumnDef="result">
                <th mat-header-cell *matHeaderCellDef>Результат</th>
                <td mat-cell *matCellDef="let task">
                  <ng-container *ngIf="!task.done; else doneTemplate">
                    <ng-container *ngIf="task.status === RecognizeStatus.Error; else processingTemplate">
                      <p class="error-text">Ошибка: {{ task.error }}</p>
                    </ng-container>
                    <ng-template #processingTemplate>
                      <p class="status-text">{{ getStatusText(task.status) }}</p>
                      <mat-progress-bar
                        *ngIf="task.status === RecognizeStatus.ApplyingPunctuationSegment"
                        mode="determinate"
                        [value]="taskProgress(task)"
                      ></mat-progress-bar>
                      <p *ngIf="task.status === RecognizeStatus.ApplyingPunctuationSegment" class="status-progress">
                        {{ task.segmentsProcessed }} / {{ task.segmentsTotal }}
                      </p>
                    </ng-template>
                  </ng-container>

                  <ng-template #doneTemplate>
                    <div class="markdown-container" [ngClass]="{ collapsed: !isExpanded(task.id) }">
                      <markdown [data]="task.resultShort"></markdown>
                    </div>
                    <div class="actions">
                      <button
                        type="button"
                        class="expand-toggle"
                        mat-icon-button
                        (click)="toggleExpand(task.id)"
                        [attr.aria-label]="isExpanded(task.id) ? 'Свернуть расшифровку' : 'Развернуть расшифровку'"
                      >
                        <mat-icon>{{ isExpanded(task.id) ? 'expand_less' : 'expand_more' }}</mat-icon>
                      </button>
                      <a [routerLink]="['/recognized', task.slug]" class="recognized-link">
                        <mat-icon aria-hidden="true">open_in_new</mat-icon>
                        <span>Полная версия</span>
                      </a>
                    </div>
                  </ng-template>
                </td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
              <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
            </table>

            <mat-spinner *ngIf="loading"></mat-spinner>
          </div>
        </mat-card-content>
      </mat-card>

      <div
        *ngIf="isMobile"
        class="mobile-tasks"
        infiniteScroll
        [scrollWindow]="true"
        [infiniteScrollDistance]="1"
        [infiniteScrollThrottle]="200"
        (scrolled)="onScrollDown()"
      >
        <div class="mobile-header-bar">
          <h2 class="mobile-heading">Очередь распознавания</h2>
          <p class="mobile-subtitle">Фильтруйте список и открывайте расшифровки без лишних блоков.</p>
        </div>

        <div class="filter-toolbar mobile-toolbar">
          <label class="filter-label" for="tasks-filter-input-mobile">Фильтр по названию или каналу</label>
          <div class="filter-field">
            <input
              #mobileFilterInput
              id="tasks-filter-input-mobile"
              type="text"
              [value]="filterValue"
              (input)="applyFilter($event)"
              placeholder="Начните печатать..."
              autocomplete="off"
            />
            <button
              *ngIf="filterValue"
              type="button"
              class="filter-reset-btn"
              (click)="clearFilter(mobileFilterInput)"
            >
              Очистить
            </button>
          </div>
        </div>

        <app-yandex-ad></app-yandex-ad>

        <div class="mobile-list">
          <article class="mobile-task" *ngFor="let task of dataSource.data">
            <header class="mobile-task-header">
              <button
                *ngIf="isAuthenticated"
                class="youtube-logo-button mobile-youtube-button"
                matRipple
                (click)="openVideoDialog(task)"
              >
                <img src="assets/yt.webp" alt="YouTube" class="youtube-logo">
              </button>
              <div class="mobile-task-meta">
                <a [routerLink]="['/recognized', task.slug]" class="mobile-task-title">{{ task.title }}</a><br>
                <span class="mobile-task-channel">Канал: {{ task.channelName }}  </span>
                <span class="mobile-task-date">{{ task.createdAt | localTime:'yyyy-MM-dd HH:mm' }}</span>                
              </div>
            </header>

            <section class="mobile-task-body">
              <ng-container *ngIf="!task.done; else mobileDone">
                <ng-container *ngIf="task.status === RecognizeStatus.Error; else mobileProcess">
                  <p class="error-text">Ошибка: {{ task.error }}</p>
                </ng-container>
                <ng-template #mobileProcess>
                  <p class="status-text">{{ getStatusText(task.status) }}</p>
                  <mat-progress-bar
                    *ngIf="task.status === RecognizeStatus.ApplyingPunctuationSegment"
                    mode="determinate"
                    [value]="taskProgress(task)"
                  ></mat-progress-bar>
                  <p *ngIf="task.status === RecognizeStatus.ApplyingPunctuationSegment" class="status-progress">
                    {{ task.segmentsProcessed }} / {{ task.segmentsTotal }}
                  </p>
                </ng-template>
              </ng-container>

              <ng-template #mobileDone>
                <div class="markdown-container" [ngClass]="{ collapsed: !isExpanded(task.id) }">
                  <markdown [data]="task.resultShort"></markdown>
                </div>
                <div class="actions mobile-actions">
                  <button
                    type="button"
                    class="expand-toggle"
                    mat-icon-button
                    (click)="toggleExpand(task.id)"
                    [attr.aria-label]="isExpanded(task.id) ? 'Свернуть расшифровку' : 'Развернуть расшифровку'"
                  >
                    <mat-icon>{{ isExpanded(task.id) ? 'expand_less' : 'expand_more' }}</mat-icon>
                  </button>
                  <a [routerLink]="['/recognized', task.slug]" class="recognized-link">
                    <mat-icon aria-hidden="true">open_in_new</mat-icon>
                    <span>Полная версия</span>
                  </a>
                </div>
              </ng-template>
            </section>
          </article>
        </div>

        <mat-spinner *ngIf="loading"></mat-spinner>
      </div>
    </section>
  </main>
</div>
