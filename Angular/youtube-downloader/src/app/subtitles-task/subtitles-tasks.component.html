<div class="subtitles-page">
  <main class="page-content">
    <section class="hero">
      <div class="hero-text">
        <h1>Лента транскрипций</h1>
        <p class="hero-lead">
          Следите за статусом обработки роликов и моментально переходите к готовым результатам. Интерфейс повторяет лёгкую
          айдентику новой страницы «О сервисе» и позволяет быстро найти нужное видео.
        </p>
        <ul class="hero-highlights">
          <li>Живое обновление статусов и прогресса обработки</li>
          <li>Поиск по названию и каналу прямо в очереди</li>
          <li>Быстрый переход к полной расшифровке</li>
        </ul>
      </div>
      <div class="hero-card">
        <div class="card-header">Статистика очереди</div>
        <div class="queue-metrics">
          <div class="metric">
            <span class="metric-label">Всего задач</span>
            <span class="metric-value">{{ totalItems | number:'1.0-0' }}</span>
          </div>
          <div class="metric">
            <span class="metric-label">Отображено</span>
            <span class="metric-value">{{ completedTasksCount | number:'1.0-0' }}</span>
          </div>
          <div class="metric">
            <span class="metric-label">В обработке</span>
            <span class="metric-value">{{ inProgressTasksCount | number:'1.0-0' }}</span>
          </div>
          <div class="metric">
            <span class="metric-label">Ошибки</span>
            <span class="metric-value">{{ failedTasksCount | number:'1.0-0' }}</span>
          </div>
        </div>
        <div class="card-hint">Статистика считает элементы на текущей странице выдачи.</div>
      </div>
    </section>

    <section class="tasks-section">
      <mat-card class="tasks-card">
        <mat-card-header>
          <mat-card-title>Очередь распознавания</mat-card-title>
          <mat-card-subtitle>Отсортируйте список, воспользуйтесь поиском или раскройте карточку, чтобы увидеть превью.</mat-card-subtitle>
        </mat-card-header>

        <mat-card-content>
          <div
            class="table-scroll"
            infiniteScroll
            [scrollWindow]="true"
            [infiniteScrollDistance]="1"
            [infiniteScrollThrottle]="200"
            (scrolled)="onScrollDown()"
          >
            <div class="filter-toolbar">
              <mat-form-field appearance="outline" class="filter-field">
                <mat-label>Фильтр по названию или каналу</mat-label>
                <input matInput placeholder="Начните печатать..." (keyup)="applyFilter($event)">
              </mat-form-field>
            </div>

            <app-yandex-ad></app-yandex-ad>

            <ng-container *ngIf="!isMobile; else mobileTemplate">
              <table
                mat-table
                [dataSource]="dataSource"
                matSort
                (matSortChange)="onSortChange($event)"
                class="custom-table"
              >
                <ng-container matColumnDef="status">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header="status">Статус</th>
                  <td mat-cell *matCellDef="let task">
                    <mat-icon [ngClass]="getStatusClass(task.status)">{{ getStatusIcon(task.status) }}</mat-icon>
                  </td>
                </ng-container>

                <ng-container matColumnDef="createdAt">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header="createdAt">Создано</th>
                  <td mat-cell *matCellDef="let task">
                    {{ task.createdAt | localTime:'yyyy-MM-dd HH:mm:ss' }}
                  </td>
                </ng-container>

                <ng-container matColumnDef="youtube">
                  <th mat-header-cell *matHeaderCellDef>Видео</th>
                  <td mat-cell *matCellDef="let task">
                    <button class="youtube-logo-button" matRipple (click)="openVideoDialog(task)">
                      <img src="assets/yt.webp" alt="YouTube" class="youtube-logo">
                    </button>
                  </td>
                </ng-container>

                <ng-container matColumnDef="title">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header="title">Название видео</th>
                  <td mat-cell *matCellDef="let task">
                    <a [routerLink]="['/recognized', task.slug]">{{ task.title }}</a>
                  </td>
                </ng-container>

                <ng-container matColumnDef="channelName">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header="channelName">Канал</th>
                  <td mat-cell *matCellDef="let task">{{ task.channelName }}</td>
                </ng-container>

                <ng-container matColumnDef="result">
                  <th mat-header-cell *matHeaderCellDef>Результат</th>
                  <td mat-cell *matCellDef="let task">
                    <ng-container *ngIf="!task.done; else doneTemplate">
                      <ng-container *ngIf="task.status === RecognizeStatus.Error; else processingTemplate">
                        <p class="error-text">Ошибка: {{ task.error }}</p>
                      </ng-container>
                      <ng-template #processingTemplate>
                        <p class="status-text">{{ getStatusText(task.status) }}</p>
                        <mat-progress-bar
                          *ngIf="task.status === RecognizeStatus.ApplyingPunctuationSegment"
                          mode="determinate"
                          [value]="taskProgress(task)"
                        ></mat-progress-bar>
                        <p *ngIf="task.status === RecognizeStatus.ApplyingPunctuationSegment" class="status-progress">
                          {{ task.segmentsProcessed }} / {{ task.segmentsTotal }}
                        </p>
                      </ng-template>
                    </ng-container>

                    <ng-template #doneTemplate>
                      <div class="markdown-container" [ngClass]="{ collapsed: !isExpanded(task.id) }">
                        <markdown [data]="task.resultShort"></markdown>
                      </div>
                      <div class="actions">
                        <button mat-stroked-button color="primary" (click)="toggleExpand(task.id)">
                          {{ isExpanded(task.id) ? 'Свернуть' : 'Развернуть' }}
                        </button>
                        <a [routerLink]="['/recognized', task.slug]" class="recognized-link">Полная версия</a>
                      </div>
                    </ng-template>
                  </td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
              </table>
            </ng-container>

            <mat-spinner *ngIf="loading"></mat-spinner>
          </div>
        </mat-card-content>
      </mat-card>
    </section>

    <ng-template #mobileTemplate>
      <div
        #mobileScroll
        class="mobile-container"
        infiniteScroll
        [infiniteScrollContainer]="mobileScroll"
        [infiniteScrollDistance]="1"
        [infiniteScrollThrottle]="200"
        (scrolled)="onScrollDown()"
      >
        <app-yandex-ad></app-yandex-ad>

        <table mat-table [dataSource]="dataSource" class="custom-table mobile-table">
          <ng-container matColumnDef="mobile">
            <th mat-header-cell *matHeaderCellDef></th>
            <td mat-cell *matCellDef="let task">
              <div class="mobile-card" [ngClass]="getStatusClass(task.status)">
                <div class="mobile-header">
                  <mat-icon class="status-icon" [ngClass]="getStatusClass(task.status)">
                    {{ getStatusIcon(task.status) }}
                  </mat-icon>
                  <div class="mobile-title">
                    <h3>{{ task.title }}</h3>
                    <p>Канал: {{ task.channelName }}</p>
                    <p>{{ task.createdAt | localTime:'yyyy-MM-dd HH:mm' }}</p>
                  </div>
                  <button class="youtube-logo-button" matRipple (click)="openVideoDialog(task)">
                    <img src="assets/yt.webp" alt="YouTube" class="youtube-logo">
                  </button>
                </div>
                <div class="mobile-body">
                  <ng-container *ngIf="!task.done; else mobileDone">
                    <ng-container *ngIf="task.status === RecognizeStatus.Error; else mobileProcess">
                      <p class="error-text">Ошибка: {{ task.error }}</p>
                    </ng-container>
                    <ng-template #mobileProcess>
                      <p class="status-text">{{ getStatusText(task.status) }}</p>
                      <mat-progress-bar
                        *ngIf="task.status === RecognizeStatus.ApplyingPunctuationSegment"
                        mode="determinate"
                        [value]="taskProgress(task)"
                      ></mat-progress-bar>
                      <p *ngIf="task.status === RecognizeStatus.ApplyingPunctuationSegment" class="status-progress">
                        {{ task.segmentsProcessed }} / {{ task.segmentsTotal }}
                      </p>
                    </ng-template>
                  </ng-container>

                  <ng-template #mobileDone>
                    <div class="markdown-container" [ngClass]="{ collapsed: !isExpanded(task.id) }">
                      <markdown [data]="task.resultShort"></markdown>
                    </div>
                    <div class="actions">
                      <button mat-stroked-button color="primary" (click)="toggleExpand(task.id)">
                        {{ isExpanded(task.id) ? 'Свернуть' : 'Развернуть' }}
                      </button>
                      <a [routerLink]="['/recognized', task.slug]" class="recognized-link">Полная версия</a>
                    </div>
                  </ng-template>
                </div>
              </div>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="['mobile']"></tr>
          <tr mat-row *matRowDef="let row; columns: ['mobile']"></tr>
        </table>

        <mat-spinner *ngIf="loading"></mat-spinner>
      </div>
    </ng-template>
  </main>
</div>
