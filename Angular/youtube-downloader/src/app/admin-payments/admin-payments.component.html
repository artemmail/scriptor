<mat-card class="table-card">
  <mat-card-header>
    <mat-card-title>YooMoney</mat-card-title>
    <mat-card-subtitle>История операций, полученная через YooMoney API</mat-card-subtitle>
  </mat-card-header>

  <mat-card-content>
    <div class="table-container">
      <div class="loading-overlay" *ngIf="loading">
        <mat-progress-spinner mode="indeterminate" diameter="48"></mat-progress-spinner>
      </div>

      <table
        mat-table
        [dataSource]="dataSource"
        class="custom-table"
        [class.table-disabled]="loading"
        *ngIf="dataSource.data.length > 0; else emptyState"
      >
        <ng-container matColumnDef="operation_id">
          <th mat-header-cell *matHeaderCellDef>Operation ID</th>
          <td mat-cell *matCellDef="let operation">
            <ng-container *ngIf="operation.operationId; else noOperationId">
              <a
                href="#"
                class="table-link"
                [matTooltip]="operation.operationId || ''"
                (click)="openOperationDetails(operation, $event)"
              >
                {{ operation.operationId }}
              </a>
            </ng-container>
            <ng-template #noOperationId>—</ng-template>
          </td>
        </ng-container>

        <ng-container matColumnDef="datetime">
          <th mat-header-cell *matHeaderCellDef>Дата</th>
          <td mat-cell *matCellDef="let operation">
            {{ operation.dateTime ? (operation.dateTime | date: 'short') : '—' }}
          </td>
        </ng-container>

        <ng-container matColumnDef="title">
          <th mat-header-cell *matHeaderCellDef>Описание</th>
          <td mat-cell *matCellDef="let operation">
            {{ operation.title || '—' }}
          </td>
        </ng-container>

        <ng-container matColumnDef="amount">
          <th mat-header-cell *matHeaderCellDef>Сумма</th>
          <td mat-cell *matCellDef="let operation">{{ formatAmount(operation) }}</td>
        </ng-container>

        <ng-container matColumnDef="type">
          <th mat-header-cell *matHeaderCellDef>Тип</th>
          <td mat-cell *matCellDef="let operation">{{ operation.type || '—' }}</td>
        </ng-container>

        <ng-container matColumnDef="direction">
          <th mat-header-cell *matHeaderCellDef>Направление</th>
          <td mat-cell *matCellDef="let operation">
            <mat-icon
              *ngIf="operation.direction === 'in'"
              class="direction-icon direction-icon--in"
              aria-label="Входящая операция"
            >
              arrow_downward
            </mat-icon>
            <mat-icon
              *ngIf="operation.direction === 'out'"
              class="direction-icon direction-icon--out"
              aria-label="Исходящая операция"
            >
              arrow_upward
            </mat-icon>
            <span *ngIf="operation.direction !== 'in' && operation.direction !== 'out'">
              {{ operation.direction || '—' }}
            </span>
          </td>
        </ng-container>

        <ng-container matColumnDef="label">
          <th mat-header-cell *matHeaderCellDef>Метка</th>
          <td mat-cell *matCellDef="let operation">
            <ng-container *ngIf="operation.label; else noLabel">
              <a
                href="#"
                class="table-link"
                (click)="openLabelDetails(operation.label, $event)"
              >
                {{ operation.label }}
              </a>
            </ng-container>
            <ng-template #noLabel>—</ng-template>
          </td>
        </ng-container>

        <ng-container matColumnDef="group_id">
          <th mat-header-cell *matHeaderCellDef>Группа</th>
          <td mat-cell *matCellDef="let operation">{{ operation.groupId || '—' }}</td>
        </ng-container>

        <ng-container matColumnDef="is_sbp_operation">
          <th mat-header-cell *matHeaderCellDef>СБП операция</th>
          <td mat-cell *matCellDef="let operation">
            <mat-icon
              *ngIf="operation.isSbpOperation === true"
              class="sbp-icon sbp-icon--success"
              aria-label="СБП операция"
            >
              check_circle
            </mat-icon>
            <mat-icon
              *ngIf="operation.isSbpOperation === false"
              class="sbp-icon sbp-icon--failed"
              aria-label="Не СБП операция"
            >
              cancel
            </mat-icon>
            <span *ngIf="operation.isSbpOperation === null">—</span>
          </td>
        </ng-container>

        <ng-container matColumnDef="spendingCategories">
          <th mat-header-cell *matHeaderCellDef>Категории расходов</th>
          <td mat-cell *matCellDef="let operation">
            <ng-container *ngIf="operation.spendingCategories.length > 0; else noCategories">
              <ng-container *ngFor="let category of operation.spendingCategories; let last = last">
                <span class="category-chip">{{ category.name || category.code || '—' }}</span>
                <br *ngIf="!last" />
              </ng-container>
            </ng-container>
            <ng-template #noCategories>—</ng-template>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns; trackBy: trackByOperationId"></tr>
      </table>

      <ng-template #emptyState>
        <div class="empty-state" *ngIf="!loading && !error">Операции YooMoney не найдены.</div>
      </ng-template>

      <div class="error-message" *ngIf="error">{{ error }}</div>
    </div>

    <mat-paginator
      [length]="total"
      [pageSize]="pageSize"
      [pageIndex]="pageIndex"
      [pageSizeOptions]="pageSizeOptions"
      [disabled]="loading"
      (page)="onPageChange($event)"
      showFirstLastButtons
    ></mat-paginator>
  </mat-card-content>
</mat-card>

<mat-card class="table-card plans-card">
  <mat-card-header>
    <mat-card-title>Тарифы (минуты и видео)</mat-card-title>
    <mat-card-subtitle>Редактирование таблицы цены, минут транскрибации и количества видео.</mat-card-subtitle>
  </mat-card-header>

  <mat-card-content>
    <div class="loading-overlay" *ngIf="loadingPlans">
      <mat-progress-spinner mode="indeterminate" diameter="36"></mat-progress-spinner>
    </div>

    <div class="plans-error" *ngIf="plansError">{{ plansError }}</div>
    <div class="plans-success" *ngIf="plansSuccess">{{ plansSuccess }}</div>

    <div class="table-container" *ngIf="plans.length > 0; else plansEmptyState">
      <table class="plans-table">
        <thead>
          <tr>
            <th>Код</th>
            <th>Название</th>
            <th>Цена</th>
            <th>Валюта</th>
            <th>Минуты</th>
            <th>Видео</th>
            <th>Приоритет</th>
            <th>Активен</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let plan of plans; trackBy: trackByPlanId">
            <td>
              <input type="text" [(ngModel)]="plan.code" (ngModelChange)="markPlanDirty(plan)" />
            </td>
            <td>
              <input type="text" [(ngModel)]="plan.name" (ngModelChange)="markPlanDirty(plan)" />
            </td>
            <td>
              <input
                type="number"
                step="1"
                min="0"
                [(ngModel)]="plan.price"
                (ngModelChange)="markPlanDirty(plan)"
              />
            </td>
            <td>
              <input type="text" maxlength="8" [(ngModel)]="plan.currency" (ngModelChange)="markPlanDirty(plan)" />
            </td>
            <td>
              <input
                type="number"
                step="1"
                min="0"
                [(ngModel)]="plan.includedTranscriptionMinutes"
                (ngModelChange)="markPlanDirty(plan)"
              />
            </td>
            <td>
              <input
                type="number"
                step="1"
                min="0"
                [(ngModel)]="plan.includedVideos"
                (ngModelChange)="markPlanDirty(plan)"
              />
            </td>
            <td>
              <input
                type="number"
                step="1"
                [(ngModel)]="plan.priority"
                (ngModelChange)="markPlanDirty(plan)"
              />
            </td>
            <td class="plan-active-cell">
              <input type="checkbox" [(ngModel)]="plan.isActive" (ngModelChange)="markPlanDirty(plan)" />
            </td>
            <td class="plan-actions">
              <button
                mat-stroked-button
                color="primary"
                type="button"
                (click)="savePlan(plan)"
                [disabled]="isSavingPlan(plan.id) || !plan.dirty"
              >
                {{ isSavingPlan(plan.id) ? 'Сохраняем…' : 'Сохранить' }}
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <ng-template #plansEmptyState>
      <div class="empty-state" *ngIf="!loadingPlans">Тарифы не найдены.</div>
    </ng-template>
  </mat-card-content>
</mat-card>
