<div class="profile-page">
  <main class="page-content">

    <header class="page-header" *ngIf="user$ | async as user">
      <div class="identity">
        <div class="avatar" aria-hidden="true">{{ getInitials(user.displayName || user.email) }}</div>
        <div class="identity-text">
          <h1>Здравствуйте, {{ user.displayName || user.email }}!</h1>
          <p>
            Управляйте подпиской, настройками и безопасностью аккаунта. Здесь собраны быстрые ссылки и актуальная
            информация.
          </p>
        </div>
      </div>
      <div class="header-actions">
        <button class="btn btn-secondary" type="button" (click)="navigateToBilling()">
          <mat-icon>credit_card</mat-icon>
          <span>Тарифы и оплата</span>
        </button>
        <button class="btn btn-logout" type="button" (click)="logout()" [disabled]="logoutInProgress">
          <mat-icon>logout</mat-icon>
          <span>{{ logoutInProgress ? 'Выходим…' : 'Выйти из аккаунта' }}</span>
        </button>
      </div>
      <p class="logout-error" *ngIf="logoutError">{{ logoutError }}</p>
    </header>

    <section class="subscription-overview">
      <div class="section-header">
        <h2>Подписка и доступ</h2>
        <p>Следите за активностью подписки, продлевайте доступ и просматривайте историю платежей.</p>
      </div>

      <div class="subscription-grid">
        <div class="subscription-card" *ngIf="summaryLoading || summary || summaryError">
          <div class="subscription-state">
            <span class="subscription-chip" [ngClass]="summaryLoading ? 'status-neutral' : subscriptionChipClass">
              {{ summaryLoading ? 'Загружаем статус подписки…' : subscriptionStatusMessage }}
            </span>
            <button class="btn btn-primary" type="button" (click)="navigateToBilling()">
              Перейти к тарифам
            </button>
          </div>
          <div class="subscription-body">
            <p class="summary-error" *ngIf="summaryError">{{ summaryError }}</p>
            <ng-container *ngIf="summary && !summaryLoading">
              <p class="summary-description" *ngIf="summary.hasActiveSubscription || summary.hasLifetimeAccess || summary.isLifetime">
                Расшифровки и распознавания доступны без ограничений. Управляйте подпиской и реквизитами в разделе биллинга.
              </p>
              <p class="summary-description" *ngIf="!summary.hasActiveSubscription && !summary.hasLifetimeAccess && !summary.isLifetime">
                Бесплатный тариф: {{ summary.freeRecognitionsPerDay }} распознавания YouTube в день и
                {{ summary.freeTranscriptionsPerMonth }} транскрибации в месяц.
              </p>
              <p class="summary-meta" *ngIf="summary.endsAt && summary.hasActiveSubscription">
                Доступ активен до {{ formatDate(summary.endsAt) }}
              </p>
            </ng-container>
          </div>
        </div>

        <div class="history-card">
          <div class="history-header">
            <h3>История платежей</h3>
            <button class="btn btn-tertiary" type="button" (click)="navigateToBilling()">Пополнить баланс</button>
          </div>
          <div class="state" *ngIf="summaryLoading && !summary">
            <mat-progress-spinner mode="indeterminate" diameter="32"></mat-progress-spinner>
            <span>Загружаем платежи…</span>
          </div>
          <ng-container *ngIf="summary && summary.payments.length > 0; else emptyPayments">
            <mat-list>
              <mat-list-item *ngFor="let payment of summary.payments">
                <div matListItemTitle>{{ payment.planName || 'Пополнение' }}</div>
                <div matListItemLine>
                  {{ formatAmount(payment.amount, payment.currency) }} · {{ formatInvoiceStatus(payment.status) }}
                </div>
                <div matListItemLine class="payment-meta">
                  {{ formatDate(payment.paidAt || payment.issuedAt) }}
                  <span *ngIf="payment.comment"> · {{ payment.comment }}</span>
                </div>
              </mat-list-item>
            </mat-list>
          </ng-container>
          <ng-template #emptyPayments>
            <div class="empty-state">
              <p>Платежей пока нет. Оформите подписку или пополните баланс, чтобы снять ограничения.</p>
              <button class="btn btn-secondary" type="button" (click)="navigateToBilling()">Перейти к биллингу</button>
            </div>
          </ng-template>
        </div>
      </div>
    </section>


    <section class="integrations">
      <div class="section-header">
        <h2>Интеграции</h2>
        <p>
          Подключите Google Calendar, чтобы добавлять встречи и поручения прямо из Scriptor и телеграм-бота.
        </p>
      </div>

      <div class="integration-card">
        <div class="integration-header">
          <div class="integration-title">
            <div class="integration-icon" aria-hidden="true">
              <mat-icon>event</mat-icon>
            </div>
            <div>
              <h3>Google Calendar</h3>
              <p>Синхронизируйте задачи и встречи с вашим календарём Google.</p>
            </div>
          </div>
          <span class="integration-chip" [ngClass]="calendarChipClass">
            {{ calendarStatusMessage }}
          </span>
        </div>

        <div class="integration-body">
          <p class="integration-secondary" *ngIf="calendarSecondaryMessage">
            {{ calendarSecondaryMessage }}
          </p>

          <div class="integration-notice" *ngIf="calendarNotification" [ngClass]="calendarNotification.type">
            <mat-icon aria-hidden="true">
              {{ calendarNotification.type === 'success' ? 'check_circle' : calendarNotification.type === 'info' ? 'info' : 'error_outline' }}
            </mat-icon>
            <span>{{ calendarNotification.text }}</span>
          </div>

          <p class="integration-warning" *ngIf="calendarBotWarning">
            <mat-icon aria-hidden="true">info</mat-icon>
            <span>{{ calendarBotWarning }}</span>
          </p>

          <p class="integration-feedback success" *ngIf="calendarActionSuccess">{{ calendarActionSuccess }}</p>
          <p class="integration-feedback error" *ngIf="calendarActionError">{{ calendarActionError }}</p>

          <div class="integration-actions">
            <div class="integration-loading" *ngIf="calendarLoading">
              <mat-progress-spinner mode="indeterminate" diameter="28"></mat-progress-spinner>
              <span>Проверяем доступ…</span>
            </div>

            <ng-container *ngIf="!calendarLoading">
              <button
                class="btn btn-primary"
                type="button"
                *ngIf="showCalendarConnectButton"
                (click)="connectGoogleCalendar()"
                [disabled]="calendarActionInProgress"
              >
                <mat-icon>sync</mat-icon>
                <span>Включить доступ</span>
              </button>

              <button
                class="btn btn-secondary"
                type="button"
                *ngIf="showCalendarDisconnectButton"
                (click)="disconnectGoogleCalendar()"
                [disabled]="calendarActionInProgress"
              >
                <mat-icon>link_off</mat-icon>
                <span>{{ calendarActionInProgress ? 'Отключаем…' : 'Отключить доступ' }}</span>
              </button>
            </ng-container>
          </div>
        </div>
      </div>
    </section>

    <section class="profile-settings">
      <div class="section-header">
        <h2>Настройки профиля</h2>
        <p>
          Введите отображаемое имя — оно появится в списке задач и в совместной работе над документами. Максимальная
          длина имени — 100 символов.
        </p>
      </div>

      <div class="settings-grid">
        <div class="settings-card">
          <div class="state" *ngIf="loading">
            <mat-progress-spinner mode="indeterminate" diameter="48"></mat-progress-spinner>
            <span>Загружаем профиль…</span>
          </div>

          <div class="state state-error" *ngIf="loadError && !loading">
            <mat-icon>error_outline</mat-icon>
            <span>{{ loadError }}</span>
          </div>

          <form class="settings-form" *ngIf="!loading && !loadError" [formGroup]="form" (ngSubmit)="submit()">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Отображаемое имя</mat-label>
              <input matInput formControlName="displayName" maxlength="100" />
              <mat-error *ngIf="form.controls.displayName.hasError('required')">
                Введите отображаемое имя.
              </mat-error>
              <mat-hint align="end">Максимум 100 символов.</mat-hint>
            </mat-form-field>

            <div class="actions">
              <div class="status-messages">
                <span class="error" *ngIf="saveError">{{ saveError }}</span>
                <span class="success" *ngIf="saveSuccess && !saveError">Изменения сохранены.</span>
              </div>
              <button class="btn btn-primary" type="submit" [disabled]="saving">
                <mat-icon *ngIf="saving">hourglass_top</mat-icon>
                <span>{{ saving ? 'Сохранение…' : 'Сохранить изменения' }}</span>
              </button>
            </div>
          </form>
        </div>

        
      </div>
    </section>
  </main>
</div>
