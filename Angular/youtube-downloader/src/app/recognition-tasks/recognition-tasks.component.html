<div class="tasks-page">
  <main class="page-content">
    <section class="hero hero--compact">
      <div class="hero-text">
        <h1>История расшифровок</h1>
        <p class="hero-lead">
          Все ваши задачи из YouScriptor в одном месте. Отслеживайте прогресс, возвращайтесь к готовым результатам и
          продолжайте работу там, где остановились.
        </p>
        <ul class="hero-highlights" *ngIf="totalTasks">
          <li><strong>{{ completedTasks }}</strong> готовых задач</li>
          <li><strong>{{ totalTasks - completedTasks }}</strong> в обработке</li>
        </ul>
        <div class="hero-actions">
          <a class="btn btn-primary" [routerLink]="['/upload']">Загрузить новую запись</a>
          <a class="btn btn-secondary" [routerLink]="['/about3']">О сервисе</a>
        </div>
      </div>

      <div class="hero-card tasks-hero-card" *ngIf="totalTasks; else emptyState">
        <div class="stats-grid">
          <div class="stat">
            <span class="stat-label">Всего задач</span>
            <span class="stat-value">{{ totalTasks }}</span>
          </div>
          <div class="stat">
            <span class="stat-label">Завершено</span>
            <span class="stat-value">{{ completedTasks }}</span>
          </div>
          <div class="stat">
            <span class="stat-label">Последнее обновление</span>
            <span class="stat-value">{{ latestUpdate ? (latestUpdate | date: 'd MMM, HH:mm') : '—' }}</span>
          </div>
        </div>
        <p class="hero-hint">
          Результаты автоматически сохраняются и доступны в любое время. Нажмите на задачу, чтобы посмотреть расшифровку.
        </p>
      </div>
    </section>

    <ng-template #emptyState>
      <div class="hero-card tasks-hero-card empty">
        <h2>Здесь появятся ваши задачи</h2>
        <p>Как только вы отправите первый файл, мы покажем прогресс и готовые результаты.</p>
        <a class="btn btn-primary" [routerLink]="['/upload']">Загрузить файл</a>
      </div>
    </ng-template>

    <section class="tasks-section">
      <div class="section-header">
        <h2>Ваши файлы и задачи</h2>
        <p>
          Управляйте расшифровками: проверяйте статус обработки, редактируйте готовый текст и скачивайте результат в пару
          кликов.
        </p>
      </div>

      <div class="tasks-grid" *ngIf="tasks.length; else noTasks">
        <article class="task-card" *ngFor="let task of tasks" [ngClass]="{ done: task.done }">
          <header class="task-header">
            <span class="status-pill" [attr.data-status]="task.status || 'unknown'">{{ task.status || '—' }}</span>
            <span class="task-language" *ngIf="task.language">{{ task.language }}</span>
          </header>

          <div class="task-meta">
            <span *ngIf="task.createdAt">Создана {{ formatLocal(task.createdAt, { day: '2-digit', month: 'long' }) }}</span>
            <span *ngIf="task.uploadDate">Загружено {{ formatLocal(task.uploadDate) }}</span>
            <span *ngIf="task.createdBy">Автор: {{ task.createdBy }}</span>
          </div>

          <div class="task-body" *ngIf="task.result || task.error; else awaiting">
            <div
              class="task-result"
              [ngClass]="{ collapsed: !isExpanded(task.id) }"
              *ngIf="task.result"
            >
              <markdown [data]="task.result"></markdown>
            </div>
            <p class="task-error" *ngIf="task.error">{{ task.error }}</p>
          </div>

          <ng-template #awaiting>
            <p class="task-awaiting">Результат будет готов после завершения обработки.</p>
          </ng-template>

          <footer class="task-actions">
            <button class="btn btn-secondary" type="button" (click)="toggleExpand(task.id)" *ngIf="task.result">
              {{ isExpanded(task.id) ? 'Свернуть' : 'Развернуть' }}
            </button>
            <a class="btn btn-primary" [routerLink]="['/recognized', task.id]">Открыть задачу</a>
          </footer>
        </article>
      </div>
    </section>

    <ng-template #noTasks>
      <div class="empty-state">
        <h3>Пока нет задач</h3>
        <p>Загрузите аудио или видео, чтобы начать расшифровку и увидеть прогресс здесь.</p>
        <a class="btn btn-primary" [routerLink]="['/upload']">Создать задачу</a>
      </div>
    </ng-template>
  </main>
</div>
