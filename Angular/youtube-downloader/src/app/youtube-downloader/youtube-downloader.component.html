<div class="youtube-downloader">
  <mat-tab-group>
    <!-- Tab 1: Импорт и объединение -->
    <mat-tab label="Импорт и объединение">
      <mat-card class="p-4">
        <mat-card-header>
          <mat-card-title>Импорт и объединение потоков</mat-card-title>
          <mat-card-subtitle>Укажите URL видео и выберите нужные потоки</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <form (submit)="fetchStreams(); $event.preventDefault()" class="stream-form flex flex-col gap-4">
            <mat-form-field appearance="outline" class="w-full">
              <mat-label>Ссылка на YouTube видео</mat-label>
              <input matInput [formControl]="videoUrlControl" placeholder="https://youtube.com/..." />
              <mat-error *ngIf="videoUrlControl.invalid">Неверный URL.</mat-error>
            </mat-form-field>
            <div class="flex justify-end">
              <button mat-flat-button color="primary" type="submit" [disabled]="isLoading">
                Загрузить потоки
              </button>
            </div>
          </form>

          <mat-progress-bar *ngIf="isLoading" mode="indeterminate" class="mt-4"></mat-progress-bar>
          <div *ngIf="errorMessage" class="error mt-4">{{ errorMessage }}</div>

          <table
            mat-table
            [dataSource]="streams"
            *ngIf="streams.length"
            class="mat-elevation-z2 w-full mt-6">

            <!-- Checkbox Column -->
            <ng-container matColumnDef="select">
              <th mat-header-cell *matHeaderCellDef></th>
              <td mat-cell *matCellDef="let s">
                <mat-checkbox
                  [checked]="isStreamSelected(s)"
                  (change)="toggleSelection(s, $event.checked)"
                  [disabled]="isRowDisabled(s)">
                </mat-checkbox>
              </td>
            </ng-container>

            <!-- Type -->
            <ng-container matColumnDef="typeIcon">
              <th mat-header-cell *matHeaderCellDef></th>
              <td mat-cell *matCellDef="let s">
                <mat-icon>{{ s.type === 'video' ? 'videocam' : 'audiotrack' }}</mat-icon>
              </td>
            </ng-container>

            <!-- Codec -->
            <ng-container matColumnDef="codec">
              <th mat-header-cell *matHeaderCellDef>Кодек</th>
              <td mat-cell *matCellDef="let s">{{ s.codec }}</td>
            </ng-container>

            <!-- Quality -->
            <ng-container matColumnDef="quality">
              <th mat-header-cell *matHeaderCellDef>Качество</th>
              <td mat-cell *matCellDef="let s">
                {{ s.qualityLabel?.label || s.qualityLabel || '-' }}
              </td>
            </ng-container>

            <!-- Bitrate -->
            <ng-container matColumnDef="bitrate">
  <th mat-header-cell *matHeaderCellDef>Битрейт</th>
  <td mat-cell *matCellDef="let s">{{ s.bitrate | bitrate }}</td>
</ng-container>

            <!-- Size -->
            <ng-container matColumnDef="size">
              <th mat-header-cell *matHeaderCellDef>Размер</th>
              <td mat-cell *matCellDef="let s">{{ s.size | fileSize }}</td>
            </ng-container>

            <!-- Language -->
            <ng-container matColumnDef="language" *ngIf="showLanguageColumn">
              <th mat-header-cell *matHeaderCellDef>Язык</th>
              <td mat-cell *matCellDef="let s">{{ s.language || '-' }}</td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
          </table>

          <div class="flex justify-end mt-4">
            <button
              mat-flat-button
              color="accent"
              (click)="mergeSelectedStreams()"
              [disabled]="!selectedStreams.length || isMerging">
              Объединить дорожки
            </button>
          </div>

          <mat-progress-bar
            *ngIf="isMerging"
            mode="determinate"
            [value]="mergeProgress"
            class="mt-4">
          </mat-progress-bar>

          <div *ngIf="mergeResult" class="mt-4 font-medium text-success">
            {{ mergeResult }}
            <a *ngIf="mergeDownloadUrl" [href]="mergeDownloadUrl" [attr.download]="mergeFileName" class="ml-2">
              Скачать файл
            </a>
          </div>
        </mat-card-content>
      </mat-card>
    </mat-tab>

    <!-- Tab 2: История задач -->
    <mat-tab label="История задач">
      <mat-card class="mt-4 p-4">
        <mat-card-header>
          <mat-card-title>История задач</mat-card-title>
          <mat-card-subtitle>Статус и прогресс объединения видео</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <div *ngIf="mergedErrorMessage" class="error">{{ mergedErrorMessage }}</div>
          <div *ngIf="!mergedVideos.length && !mergedErrorMessage">Задач пока нет.</div>

          <table
            mat-table
            [dataSource]="mergedVideos"
            *ngIf="mergedVideos.length"
            class="mat-elevation-z2 w-full">

            <!-- VIDEO (YouTube link with title text) -->
            <ng-container matColumnDef="video">
              <th mat-header-cell *matHeaderCellDef>Видео</th>
              <td mat-cell *matCellDef="let v">
                <a *ngIf="v.youtubeId"
                   [href]="'https://youtu.be/' + v.youtubeId"
                   target="_blank" rel="noopener">
                  {{ v.title || v.fileName || v.youtubeId }}
                </a>
                <span *ngIf="!v.youtubeId">
                  {{ v.title || v.fileName || '—' }}
                </span>
              </td>
            </ng-container>

            <!-- Status -->
            <ng-container matColumnDef="status">
              <th mat-header-cell *matHeaderCellDef>Статус</th>
              <td mat-cell *matCellDef="let v">{{ v.status }}</td>
            </ng-container>

            <!-- Progress -->
            <ng-container matColumnDef="progress">
              <th mat-header-cell *matHeaderCellDef>Прогресс</th>
              <td mat-cell *matCellDef="let v">
                <mat-progress-bar mode="determinate" [value]="v.progress"></mat-progress-bar>
                <span class="ml-2">{{ v.progress }}%</span>
              </td>
            </ng-container>

            <!-- Action (download button only) -->
            <ng-container matColumnDef="action">
              <th mat-header-cell *matHeaderCellDef>Действие</th>
              <td mat-cell *matCellDef="let v">
                <button
                  mat-stroked-button
                  color="primary"
                  [disabled]="!v.filePath"
                  (click)="downloadMergedVideo(v)">
                  Скачать
                </button>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="['video','status','progress','action']"></tr>
            <tr mat-row *matRowDef="let row; columns: ['video','status','progress','action']"></tr>
          </table>
        </mat-card-content>
      </mat-card>
    </mat-tab>
  </mat-tab-group>
</div>
