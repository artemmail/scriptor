<div class="downloader-page">
  <main class="page-content">
    <section class="hero">
      <div class="hero-text">
        <h1>Скачать YouTube видео/аудио с выбором дорожек</h1>
        <p class="hero-lead">
          YouTube хранит видео/аудио потоки разного качетва в отдельных файлах. Вы можете выбрать нужные дорожки с скачать в итоговый файл:
        </p>
        <ul class="hero-highlights">
          <li *ngFor="let highlight of heroHighlights">{{ highlight }}</li>
        </ul>
        <div class="hero-actions">
          <button class="btn btn-primary" type="button" (click)="scrollToWorkspace()">
            <mat-icon>play_circle</mat-icon>
            <span>Начать работу</span>
          </button>
          <a class="btn btn-secondary" [routerLink]="['/transcriptions']">
            <mat-icon>record_voice_over</mat-icon>
            <span>К расшифровкам</span>
          </a>
        </div>
      </div>
      <div class="hero-card">
        <div class="card-header">Продвинутая онлнайн утилита для скачивания с YouTube</div>
        <div class="card-dropzone">
          <p>Вставьте ссылку, выберите дорожки и запустите объединение. Можно закрыть страницу сайта и вернуться позже</p>
          
          <button class="btn btn-primary" type="button" (click)="scrollToWorkspace()">
            <mat-icon>bolt</mat-icon>
            <span>Перейти к форме</span>
          </button>
        </div>
        <div class="card-preview">
          <div class="card-preview-caption">Что вы получаете:</div>
          <ul class="card-preview-list">
            <li *ngFor="let highlight of cardHighlights">
              <h4>{{ highlight.title }}</h4>
              <p>{{ highlight.description }}</p>
            </li>
          </ul>
        </div>
      </div>
    </section>

    <section class="workspace" id="downloader-workspace">
      <div class="section-header">
        <h2>Рабочая область</h2>
        <p>Вставьте ссылку на ролик, отметьте дорожки и наблюдайте за прогрессом объединения и историей задач.</p>
      </div>

      <div class="workspace-grid">
        <div class="panel import-panel">
          <div class="panel-header">
            <h3>Импорт и объединение потоков</h3>
            <span
              *ngIf="mergeStatus || isMerging"
              class="status-chip"
              [ngClass]="{
                'status-running': isMerging && mergeStatus !== 'Done' && mergeStatus !== 'Error',
                'status-done': mergeStatus === 'Done',
                'status-error': mergeStatus === 'Error'
              }"
            >
              {{ mergeStatus || 'В обработке' }}
            </span>
          </div>

          <div class="panel-body">
            <p class="panel-description">
              Сервис автоматически сортирует потоки по типу и качеству. Отметьте подходящие дорожки и запустите
              объединение — результат появится в истории задач и будет доступен для скачивания.
            </p>

            <form (submit)="fetchStreams(); $event.preventDefault()" class="stream-form">
              <label class="stream-form-label" for="downloader-input">Введите идентификатор или ссылку YouTube</label>
              <div class="stream-form-field">
                <input
                  id="downloader-input"
                  type="text"
                  [formControl]="videoUrlControl"
                  placeholder="https://youtube.com/..."
                  autocomplete="off"
                />
                <button class="btn btn-primary" type="submit" [disabled]="isLoading">
                  {{ isLoading ? 'Загружаем…' : 'Загрузить потоки' }}
                </button>
              </div>
            </form>

            <mat-progress-bar *ngIf="isLoading" mode="indeterminate"></mat-progress-bar>

            <div class="error" *ngIf="errorMessage">{{ errorMessage }}</div>

            <div class="quick-tips" *ngIf="quickTips.length">
              <h4>Подсказки</h4>
              <ul>
                <li *ngFor="let tip of quickTips">{{ tip }}</li>
              </ul>
            </div>

            <div class="table-wrapper" *ngIf="streams.length">
              <table mat-table [dataSource]="streams" class="mat-elevation-z2 selection-table">
                <ng-container matColumnDef="select">
                  <th mat-header-cell *matHeaderCellDef></th>
                  <td mat-cell *matCellDef="let s">
                    <mat-checkbox
                      [checked]="isStreamSelected(s)"
                      (change)="toggleSelection(s, $event.checked)"
                      [disabled]="isRowDisabled(s)"
                    ></mat-checkbox>
                  </td>
                </ng-container>

                <ng-container matColumnDef="typeIcon">
                  <th mat-header-cell *matHeaderCellDef></th>
                  <td mat-cell *matCellDef="let s">
                    <mat-icon>{{ s.type === 'video' ? 'videocam' : 'audiotrack' }}</mat-icon>
                  </td>
                </ng-container>

                <ng-container matColumnDef="codec">
                  <th mat-header-cell *matHeaderCellDef>Кодек</th>
                  <td mat-cell *matCellDef="let s">{{ s.codec }}</td>
                </ng-container>

                <ng-container matColumnDef="quality">
                  <th mat-header-cell *matHeaderCellDef>Качество</th>
                  <td mat-cell *matCellDef="let s">{{ s.qualityLabel?.label || s.qualityLabel || '-' }}</td>
                </ng-container>

                <ng-container matColumnDef="bitrate">
                  <th mat-header-cell *matHeaderCellDef>Битрейт</th>
                  <td mat-cell *matCellDef="let s">{{ s.bitrate | bitrate }}</td>
                </ng-container>

                <ng-container matColumnDef="size">
                  <th mat-header-cell *matHeaderCellDef>Размер</th>
                  <td mat-cell *matCellDef="let s">{{ s.size | fileSize }}</td>
                </ng-container>

                <ng-container matColumnDef="language" *ngIf="showLanguageColumn">
                  <th mat-header-cell *matHeaderCellDef>Язык</th>
                  <td mat-cell *matCellDef="let s">{{ s.language || '-' }}</td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                <tr mat-row *matRowDef="let row; columns: displayedColumns" [class.disabled-row]="isRowDisabled(row) && !isStreamSelected(row)"></tr>
              </table>
            </div>

            <div class="empty-state" *ngIf="!streams.length && !isLoading">
              <h4>Нет загруженных потоков</h4>
              <p>Вставьте ссылку на видео и нажмите «Загрузить потоки», чтобы выбрать нужные дорожки.</p>
            </div>

            <div class="merge-actions">
              <button
                mat-flat-button
                color="accent"
                (click)="mergeSelectedStreams()"
                [disabled]="!selectedStreams.length || isMerging"
              >
                Объединить дорожки
              </button>

              <div class="merge-progress" *ngIf="isMerging || mergeStatus">
                <div class="progress-header">
                  <span>{{ mergeStatus || 'Подготовка задачи' }}</span>
                  <span>{{ mergeProgress }}%</span>
                </div>
                <mat-progress-bar mode="determinate" [value]="mergeProgress"></mat-progress-bar>
              </div>
            </div>

            <div class="status-banner" *ngIf="mergeResult || mergeDownloadUrl">
              <div class="status-text">
                <strong *ngIf="mergeResult">{{ mergeResult }}</strong>
                <span *ngIf="!mergeResult && mergeStatus">Статус: {{ mergeStatus }} ({{ mergeProgress }}%)</span>
              </div>
              <a
                *ngIf="mergeDownloadUrl"
                [href]="mergeDownloadUrl"
                [attr.download]="mergeFileName"
                class="btn btn-outline"
              >
                <mat-icon>download</mat-icon>
                <span>Скачать файл</span>
              </a>
            </div>
          </div>
        </div>

        <div class="panel history-panel">
          <div class="panel-header">
            <h3>История задач</h3>
            <button class="icon-button" type="button" (click)="loadMergedVideos()" aria-label="Обновить список">
              <mat-icon>refresh</mat-icon>
            </button>
          </div>
          <div class="panel-body">
            <div class="error" *ngIf="mergedErrorMessage">{{ mergedErrorMessage }}</div>

            <div class="empty-state" *ngIf="!mergedVideos.length && !mergedErrorMessage">
              <h4>Задач пока нет</h4>
              <p>Как только вы запустите объединение, готовые файлы появятся здесь.</p>
            </div>

            <div class="history-table" *ngIf="mergedVideos.length">
              <table mat-table [dataSource]="mergedVideos">
                <ng-container matColumnDef="video">
                  <th mat-header-cell *matHeaderCellDef>Видео</th>
                  <td mat-cell *matCellDef="let v">
                    <a
                      *ngIf="v.youtubeId"
                      [href]="'https://youtu.be/' + v.youtubeId"
                      target="_blank"
                      rel="noopener"
                    >
                      {{ v.title || v.fileName || v.youtubeId }}
                    </a>
                    <span *ngIf="!v.youtubeId">{{ v.title || v.fileName || '—' }}</span>
                  </td>
                </ng-container>

                <ng-container matColumnDef="status">
                  <th mat-header-cell *matHeaderCellDef>Статус</th>
                  <td mat-cell *matCellDef="let v">{{ v.status }}</td>
                </ng-container>

                <ng-container matColumnDef="progress">
                  <th mat-header-cell *matHeaderCellDef>Прогресс</th>
                  <td mat-cell *matCellDef="let v">
                    <div class="history-progress">
                      <mat-progress-bar mode="determinate" [value]="v.progress"></mat-progress-bar>
                      <span>{{ v.progress }}%</span>
                    </div>
                  </td>
                </ng-container>

                <ng-container matColumnDef="action">
                  <th mat-header-cell *matHeaderCellDef>Действие</th>
                  <td mat-cell *matCellDef="let v">
                    <button
                      mat-stroked-button
                      color="primary"
                      [disabled]="!v.filePath"
                      (click)="downloadMergedVideo(v)"
                    >
                      Скачать
                    </button>
                  </td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="['video', 'status', 'progress', 'action']"></tr>
                <tr mat-row *matRowDef="let row; columns: ['video', 'status', 'progress', 'action']"></tr>
              </table>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>
</div>
