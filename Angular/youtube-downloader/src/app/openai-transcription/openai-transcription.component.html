<div class="transcription-page">
  <mat-card class="upload-card">
    <div class="upload-card-text">
      <h2>Новая расшифровка</h2>
      <p class="upload-hint">
        Загрузите аудио или видео файл с компьютера или укажите прямую ссылку (Яндекс.Диск и т.д.),
        чтобы отправить его в обработку через OpenAI.
      </p>
    </div>
    <div class="upload-actions">
      <button mat-raised-button color="primary" (click)="openUploadDialog()" [disabled]="uploading">
        <mat-icon>cloud_upload</mat-icon>
        <span>Загрузить</span>
      </button>
    </div>
    <div class="upload-caption">Все параметры загрузки доступны внутри диалога.</div>
  </mat-card>

  <div class="layout">
    <mat-card class="tasks-card">
      <div class="card-header">
        <h2>Мои расшифровки</h2>
        <button mat-icon-button (click)="loadTasks()" [disabled]="uploading">
          <mat-icon>refresh</mat-icon>
        </button>
      </div>
      <div class="error" *ngIf="listError">{{ listError }}</div>
      <mat-nav-list *ngIf="tasks.length; else emptyTasks">
        <a
          mat-list-item
          *ngFor="let task of tasks; trackBy: trackTask"
          (click)="selectTask(task)"
          [class.active]="task.id === selectedTaskId"
        >
          <mat-icon matListItemIcon>{{ getTaskIcon(task) }}</mat-icon>
          <span matListItemTitle>{{ task.displayName }}</span>
          <span matListItemLine>
            {{ getStatusText(task.status) }} · {{ task.modifiedAt | localTime }}
          </span>
        </a>
      </mat-nav-list>
      <ng-template #emptyTasks>
        <div class="empty-state">Здесь появятся ваши распознанные файлы.</div>
      </ng-template>
    </mat-card>

    <mat-card class="details-card" *ngIf="selectedTaskId; else selectPrompt">
      <ng-container *ngIf="detailsLoading; else taskDetails">
        <div class="loading-state">
          <mat-progress-spinner mode="indeterminate" diameter="40"></mat-progress-spinner>
          <p>Загружаем данные задачи…</p>
        </div>
      </ng-container>

      <ng-template #taskDetails>
        <ng-container *ngIf="selectedTask; else detailsErrorBlock">
          <div class="details-header">
            <h2>{{ selectedTask.displayName }}</h2>
            <span class="status-chip" [ngClass]="getStatusClass(selectedTask.status)">
              {{ getStatusText(selectedTask.status) }}
            </span>
          </div>

          <div class="clarification-display" *ngIf="selectedTask.clarification">
            <strong>Уточнение:</strong>
            <span>{{ selectedTask.clarification }}</span>
          </div>

          <div class="error" *ngIf="selectedTask.error && !isTaskCompleted(selectedTask)">
            {{ selectedTask.error }}
          </div>

          <ng-container *ngIf="isTaskCompleted(selectedTask); else processingView">
            <section class="result-block">
              <h3>Результат</h3>
              <div class="result-actions">
                <button
                  mat-stroked-button
                  color="primary"
                  [routerLink]="['/transcriptions', selectedTask.id, 'edit']"
                >
                  <mat-icon>edit</mat-icon>
                  <span>Редактировать</span>
                </button>
                <button
                  mat-stroked-button
                  color="primary"
                  (click)="exportDocx()"
                  [disabled]="exportingDocx"
                >
                  <mat-icon>description</mat-icon>
                  <span>Word</span>
                </button>
                <button
                  mat-stroked-button
                  color="primary"
                  (click)="exportPdf()"
                  [disabled]="exportingPdf"
                >
                  <mat-icon>picture_as_pdf</mat-icon>
                  <span>PDF</span>
                </button>
                <button
                  mat-stroked-button
                  color="primary"
                  (click)="downloadMarkdown()"
                  [disabled]="!hasMarkdown()"
                >
                  <mat-icon>code</mat-icon>
                  <span>Markdown</span>
                </button>
                <button
                  mat-stroked-button
                  color="primary"
                  (click)="downloadSrt()"
                  [disabled]="!canDownloadSrt() || downloadingSrt"
                >
                  <mat-icon>subtitles</mat-icon>
                  <span>SRT</span>
                </button>
              </div>
              <div class="error" *ngIf="exportError">{{ exportError }}</div>
              <div
                class="markdown-content"
                *ngIf="renderedMarkdown; else plainResult"
                [innerHTML]="renderedMarkdown"
              ></div>
              <ng-template #plainResult>
                <pre *ngIf="hasMarkdown(); else recognizedFallback">{{ markdownContent }}</pre>
              </ng-template>
              <ng-template #recognizedFallback>
                <pre *ngIf="selectedTask.recognizedText; else emptyResult">{{ selectedTask.recognizedText }}</pre>
              </ng-template>
              <ng-template #emptyResult>
                <div class="empty-state">Результат пока недоступен.</div>
              </ng-template>
            </section>
          </ng-container>

          <ng-template #processingView>
            <div
              class="details-actions"
              *ngIf="selectedTask.status === OpenAiTranscriptionStatus.Error"
            >
              <button
                mat-stroked-button
                color="primary"
                (click)="continueTask()"
                [disabled]="continueInProgress"
              >
                <mat-icon>play_arrow</mat-icon>
                <span>Продолжить задачу</span>
              </button>
              <mat-progress-spinner
                *ngIf="continueInProgress"
                mode="indeterminate"
                diameter="28"
                class="inline-spinner"
              ></mat-progress-spinner>
              <div class="error" *ngIf="continueError">{{ continueError }}</div>
            </div>

            <section class="steps-section" *ngIf="selectedTask.steps.length">
              <h3>Прогресс обработки</h3>
              <ul class="steps-list">
                <li *ngFor="let step of selectedTask.steps; trackBy: trackStep" [ngClass]="getStepClass(step.status)">
                  <mat-icon>{{ getStepIcon(step.status) }}</mat-icon>
                  <div class="step-content">
                    <div class="step-title">{{ getStatusText(step.step) }}</div>
                    <div class="step-meta">
                      <span>{{ getStepStatusText(step.status) }}</span>
                      <span *ngIf="step.startedAt">· {{ step.startedAt | localTime }}</span>
                      <span *ngIf="step.finishedAt">· {{ step.finishedAt | localTime }}</span>
                    </div>
                    <div class="step-error" *ngIf="step.error">{{ step.error }}</div>
                  </div>
                </li>
              </ul>
            </section>
          </ng-template>
        </ng-container>

        <ng-template #detailsErrorBlock>
          <div class="error">{{ detailsError }}</div>
        </ng-template>
      </ng-template>
    </mat-card>

    <ng-template #selectPrompt>
      <mat-card class="details-card empty-details">
        <div class="empty-state">Выберите задачу, чтобы посмотреть подробности.</div>
      </mat-card>
    </ng-template>
  </div>
</div>
