<div class="page-shell">
  <section class="topic-creation" *ngIf="canCreateTopics">
    <mat-card>
      <mat-card-title>Новая тема</mat-card-title>
      <mat-card-content>
        <p>Используйте редактор с поддержкой Markdown и LaTeX, чтобы оформить новую публикацию.</p>
        <button mat-flat-button color="primary" [routerLink]="['/blog/new']">
          Открыть редактор
        </button>
      </mat-card-content>
    </mat-card>
  </section>

  <div class="feed-state" *ngIf="feedError">{{ feedError }}</div>
  <div class="feed-state" *ngIf="!loading && initialLoad && topics.length === 0 && !feedError">
    Пока нет тем. Создайте первую!
  </div>

  <div
    class="blog-container"
    infiniteScroll
    [scrollWindow]="true"
    [infiniteScrollDistance]="2"
    [infiniteScrollThrottle]="200"
    [infiniteScrollDisabled]="loading || allLoaded"
    (scrolled)="onScrollDown()"
  >
    <mat-card class="blog-card" *ngFor="let topic of topics; trackBy: trackByTopicId">
      <mat-card-header>
        <mat-card-title>{{ topic.header }}</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="topic-meta">
          <b class="topic-author">{{ topic.user }}</b>
          <span>{{ topic.createdAt | date: 'd MMM yyyy, H:mm' }}</span>
          <span class="topic-comments-count" *ngIf="topic.commentCount > 0">
            Комментариев: {{ topic.commentCount }}
          </span>
        </div>

        <div class="content" [class.collapsed]="topic.collapsed" [innerHTML]="topic.renderedText"></div>

        <div class="card-actions">
          <button
            mat-button
            color="primary"
            class="toggle"
            *ngIf="topic.textIsTooLong"
            (click)="toggleCollapse(topic)"
          >
            {{ topic.collapsed ? 'Развернуть' : 'Свернуть' }}
          </button>
          <a mat-stroked-button color="primary" [routerLink]="['/blog', topic.slug]">
            Читать полностью
          </a>
          <div class="moderation-actions" *ngIf="isModerator">
            <span class="action-error" *ngIf="topic.actionError">{{ topic.actionError }}</span>
            <button mat-stroked-button color="primary" (click)="editTopic(topic)">
              Редактировать
            </button>
            <button
              mat-stroked-button
              color="warn"
              (click)="deleteTopic(topic)"
              [disabled]="topic.deleting"
            >
              {{ topic.deleting ? 'Удаление…' : 'Удалить' }}
            </button>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <div class="feed-loader" *ngIf="loading && topics.length > 0">
      <mat-spinner diameter="36"></mat-spinner>
    </div>

    <div class="feed-end" *ngIf="allLoaded && topics.length > 0">
      Больше нет записей
    </div>
  </div>

  <div class="initial-loader" *ngIf="loading && topics.length === 0">
    <mat-spinner diameter="40"></mat-spinner>
  </div>
</div>
